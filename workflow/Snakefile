# Snakefile
from snakemake.io import glob_wildcards


configfile: "config/config.yaml"


rule all:
    input:
        expand([
            "{root_dir}/derivatives/{derivatives_subfolder}/preprocessed_data/sub-{subject}/"  # preprocessed_dataessed snirf
            "sub-{subject}_task-{task}_run-{run}_nirs_preprocessed.snirf",
             
             "{root_dir}/derivatives/{derivatives_subfolder}/plots/DQR/"  # DQR plots 
             "sub-{subject}_task-{task}_run-{run}_nirs_DQR.png",
             
             "{root_dir}/derivatives/{derivatives_subfolder}/plots/DQR/gvtd/"   # gvtd DQR plots
             "sub-{subject}_task-{task}_run-{run}_nirs_DQR_gvtd_hist.png",
             
             "{root_dir}/derivatives/{derivatives_subfolder}/plots/DQR/slope/"   # slope DQR plots
             "sub-{subject}_task-{task}_run-{run}_nirs_slope.png",
             
            ],
            root_dir = config["dataset"]["root_dir"],
            derivatives_subfolder = config["dataset"]["derivatives_subfolder"],
            subject = config["dataset"]["subject"],
            task = config["dataset"]["task"],
            run = config["dataset"]["run"]
            )
        
        

rule preprocess:
    input:
        # raw .snirf and events.tsv
        "{root_dir}/sub-{subject}/nirs/sub-{subject}_task-{task}_run-{run}_nirs.snirf",
        "{root_dir}/sub-{subject}/nirs/sub-{subject}_task-{task}_run-{run}_events.tsv"
    output:
        # preprocessed snirf
        "{root_dir}/derivatives/{derivatives_subfolder}/preprocessed_data/sub-{subject}/"
        "sub-{subject}_task-{task}_run-{run}_nirs_preprocessed.snirf",
        
        "{root_dir}/derivatives/{derivatives_subfolder}/plots/DQR/"  # DQR plots 
        "sub-{subject}_task-{task}_run-{run}_nirs_DQR.png",
        
        "{root_dir}/derivatives/{derivatives_subfolder}/plots/DQR/gvtd/"   # gvtd DQR plots
        "sub-{subject}_task-{task}_run-{run}_nirs_DQR_gvtd_hist.png",
        
        "{root_dir}/derivatives/{derivatives_subfolder}/plots/DQR/slope/"   # slope DQR plots
        "sub-{subject}_task-{task}_run-{run}_nirs_slope.png",

    script:
        "scripts/preprocess.py"


def all_preprocessed_runs(wc):
    ''' Return a list of all preprocessed .snirf files for this subject+task (i.e. all runs)'''
    # build pattern where {run} is still a wildcard
    pattern = (
        f"{wc.root_dir}/{wc.derivatives_subfolder}/preprocessed_data/sub-{wc.subject}/"
        f"sub-{wc.subject}_task-{wc.task}_run-{{run}}_nirs_preprocessed.snirf"
    )
    gw = glob_wildcards(pattern)  
    full_paths = [pattern.format(run=r) for r in gw.run] # rebuild filepath for each run
    
    return full_paths


rule blockaverage:
    input:
        preproc_runs = all_preprocessed_runs
        # preprocessed time series data
        #"{root_dir}/derivatives/{derivatives_subfolder}/preprocessed_data/sub-{subject}/"
        #"sub-{subject}_task-{task}_run-{run}_nirs_preprocessed.snirf"
        #rules.preprocess.output[0]
        
        
    output:
        # block averaged data containing HRF for each task
        "{root_dir}/derivatives/{derivatives_subfolder}/blockaverage/sub-{subject}/"
        "sub-{subject}_task-{task}_run-{run}_nirs_blockaverage.snirf"
        
    script:
        "scripts/blockaverage.py"
    
    






